name: CI

on:
  push:
    tags:
      - 'v*'        # tag pushes like v1.2.3
    branches:
      - main        # also run on pushes to main (we'll detect tags pointing at the pushed commit)
  pull_request:

jobs:
  pre-commit:
    name: pre-commit checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install poetry pre-commit
      - name: Install dependencies
        run: poetry install --with dev
      - name: Run pre-commit
        run: SKIP=pylint pre-commit run --all-files

  publish:
    name: Build, Publish & Release
    needs: pre-commit
    # allow tag pushes OR pushes to main (the step below will detect a tag pointing at the commit)
    if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Validate tag is valid SemVer (vX.Y.Z) and on origin/main
        id: validate_tag
        run: |
          set -euo pipefail
          TAG_REF="$GITHUB_REF"

          if [[ "$TAG_REF" =~ ^refs/tags/ ]]; then
            # direct tag push
            TAG="${TAG_REF#refs/tags/}"
          else
            # push to main: try to find a tag pointing at the pushed commit
            git fetch --no-tags --prune origin
            git fetch origin --tags
            TAG=$(git tag --points-at "$GITHUB_SHA" | grep -E '^v' | head -n1 || true)
            if [ -z "$TAG" ]; then
              echo "No tag pointing at $GITHUB_SHA; nothing to publish. Exiting job."
              # make sure we emit an empty version output so downstream steps can check it
              echo "version=" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi
          echo "Found tag: $TAG"

          # Basic SemVer check allowing prerelease/build metadata:
          if [[ ! "$TAG" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)(-[0-9A-Za-z.-]+)?(\+[0-9A-Za-z.-]+)?$ ]]; then
            echo "ERROR: Tag '$TAG' is not a valid SemVer prefixed with 'v' (e.g. v1.2.3)"
            exit 0
          fi

          # Ensure the tag's commit is contained in origin/main
          TAG_SHA=$(git rev-list -n 1 "$TAG")
          git fetch origin main:refs/remotes/origin/main
          if ! git branch -r --contains "$TAG_SHA" | grep -q 'origin/main'; then
            echo "ERROR: Tag '$TAG' (commit $TAG_SHA) is not contained in origin/main. Aborting publish."
            exit 0
          fi

          echo "version=$TAG" >> "$GITHUB_OUTPUT"

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Install dependencies
        run: poetry install --with dev

      - name: Build package
        if: ${{ steps.validate_tag.outputs.version != '' }}
        run: poetry build

      - name: Publish to PyPI
        if: ${{ steps.validate_tag.outputs.version != '' }}
        env:
          POETRY_PYPI_TOKEN_PYPI: ${{ secrets.POETRY_PYPI_TOKEN_PYPI }}
        run: |
          # configure poetry auth and publish
          poetry publish --no-interaction

      - name: Create GitHub Release
        if: ${{ steps.validate_tag.outputs.version != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.validate_tag.outputs.version }}
          name: Release ${{ steps.validate_tag.outputs.version }}
          generate_release_notes: true
